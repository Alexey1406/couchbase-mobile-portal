<?xml version="1.0" encoding="UTF-8"?>
<article xmlns:xi="http://www.w3.org/2001/XInclude"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="../../../../docs.xsd"
         id="working-with-the-rest-api">
   <title>Working With the REST API</title>
   <description>TODO: Add description.</description>
   <introduction>
      <paragraph>Couchbase Lite has an <emphasis>optional</emphasis> HTTP-based REST API interface that provides access to nearly all Couchbase Lite functionality through HTTP requests. The API is useful when you want to:</paragraph>
      <unordered-list>
         <list-item>Support embedded web applications that access the REST API through AJAX. These apps can easily be packaged up into native apps by using a development framework such as <external-ref href="http://phonegap.com"/>.</list-item>
         <list-item>Enable apps written in other languages such as C#, which have client libraries available that can communicate with the REST API.</list-item>
         <list-item>Support peer-to-peer replication over Wi-Fi between apps on two devices.</list-item>
      </unordered-list>
      <paragraph>The HTTP API follows the architectural style known as REST (Representational State Transfer), in which resources identified by URLs act as objects and the basic HTTP verbs act as methods. This maps very well to the fundamental create, read, update, and delete (CRUD) operations of a database. It's also similar to the read-write extension of HTTP, [WebDAV][WEBDAV].</paragraph>
   </introduction>
   <topics>
      <topic id="enabling-the-rest-api">
         <title>Enabling the REST API</title>
         <body>
            <paragraph>The code that handles this API isn't in the core Couchbase Lite library, for size reasons. Instead it's in an additional framework called <code>CouchbaseLiteListener</code>. To use the REST API, you need to link this framework into your app.</paragraph>
            <paragraph>Once you've done this, you can call the method <code>-internalURL</code> on the top-level <code>CBLManager</code> instance, or on any <code>CBLDatabase</code> instance, to get its equivalent URL. You can then derive other entities' URLs relative to it and send them requests.</paragraph>
            <paragraph>Couchbase Lite doesn't communicate with your app over TCP sockets because it's already built into the app; instead it fakes it by registering a fake hostname (which ends with <code>.couchbase.</code>). As long as your app uses the platform-standard URL access API (<code>NSURLConnection</code> on iOS or Mac OS), it can make HTTP requests using this fake hostname and they'll be routed directly to the Couchbase Lite thread.</paragraph>
            <paragraph>You don't need to know the details of the hostname, and shouldn't hardcode it as it might change (and has changed twice already!) Instead, the <code>internalURL</code> property of a <code>CBLDatabase</code> or the <code>CBLManager</code> gives you the URL to use.</paragraph>
         </body>
      </topic>
      <topic id="serving-the-rest-api">
         <title>Serving the REST API</title>
         <body>
            <paragraph>If you want external clients to be able to connect to the REST API, to enable peer-to-peer replication, you'll need to instantiate a CBLListener object.</paragraph>
            <code-block>
#import &lt;CouchbaseLiteListener/CBLListener.h&gt;

CBLManager* manager = [CBLManager sharedInstance];
_listener = [[CBLListener alloc] initWithManager: manager port: 0];
_listener.readOnly = YES;  // Do this to prevent writes to your databases
_listener.passwords = @{@"naomi": @"letmein"};
BOOL ok = [_listener start];
UInt16 actualPort = _listener.port;  // the actual TCP port it's listening on
</code-block>
            <paragraph>You're now running a live HTTP server. Other devices can connect to it and replicate with your databases. You will definitely want to lock this down to prevent anything malicious from reading or changing your app's data! Note how the above snippet makes the listener read-only, so remote clients can only pull from, not push to, your databases; it then sets a username and password, which implicitly disables anonymous access.</paragraph>
         </body>
      </topic>
      <topic id="being-a-client">
         <title>Being a Client</title>
         <body>
            <paragraph>For another instance of your app to be able to connect to your listener and replicate with your databases, first it has to be able to <emphasis>find</emphasis> it. The easiest way to enable that is to turn on the Bonjour service on the listener:</paragraph>
            <code-block>
[_listener setBonjourName: @"John Smith" type: @"_myshoppinglist._http._tcp"];
</code-block>
            <paragraph>On the client side, you can now use an <code>NSNetServiceBrowser</code> to browse for services of type <code>_myshoppinglist._http._tcp</code>, and registered listeners will show up. Typically you display them in a table view in the UI and let the user pick the right one by name.</paragraph>
            <paragraph>To connect, you resolve the chosen service's IP address and port, construct an HTTP URL from them, append the database name, and then use that as the remote URL of a CBLReplication. Don't forget to add credentials, since the listener is probably password-protected; you'll probably have to prompt the user to enter them the first time.</paragraph>
         </body>
      </topic>
   </topics>
</article>
